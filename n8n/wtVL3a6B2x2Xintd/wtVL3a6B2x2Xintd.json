{"active":true,"connections":{"Antwort formatieren":{"main":[[{"index":0,"node":"Antwort an Fonio","type":"main"}]]},"Auswahl verarbeiten":{"main":[[{"index":0,"node":"Modus prüfen","type":"main"}]]},"Beschreibung des Trainingsbereichs holen":{"main":[[{"index":0,"node":"Message a model","type":"main"}]]},"Existiert Trainingsbereich?":{"main":[[{"index":0,"node":"Beschreibung des Trainingsbereichs holen","type":"main"}],[{"index":0,"node":"Trainingsbereich existiert nicht","type":"main"}]]},"Fonio Webhook Trigger":{"main":[[{"index":0,"node":"Google Sheets lesen","type":"main"}]]},"Google Sheets lesen":{"main":[[{"index":0,"node":"Auswahl verarbeiten","type":"main"}]]},"Liste der Trainingsbereiche":{"main":[[{"index":0,"node":"Antwort an Fonio","type":"main"}]]},"Message a model":{"main":[[{"index":0,"node":"Antwort formatieren","type":"main"}]]},"Modus prüfen":{"main":[[{"index":0,"node":"Situation 'check'","type":"main"}],[{"index":0,"node":"Situation 'random'","type":"main"}],[{"index":0,"node":"Situation 'list'","type":"main"}],[],[]]},"Situation 'check'":{"main":[[{"index":0,"node":"Existiert Trainingsbereich?","type":"main"}]]},"Situation 'list'":{"main":[[{"index":0,"node":"Liste der Trainingsbereiche","type":"main"}]]},"Situation 'random'":{"main":[[{"index":0,"node":"Beschreibung des Trainingsbereichs holen","type":"main"}]]},"Trainingsbereich existiert nicht":{"main":[[{"index":0,"node":"Antwort an Fonio","type":"main"}]]}},"name":"fonio Training Persona Generator","nodes":[{"name":"Fonio Webhook Trigger","parameters":{"httpMethod":"POST","options":{},"path":"fonio-training-trigger","responseMode":"responseNode"},"position":[368,1664],"type":"n8n-nodes-base.webhook","typeVersion":1,"webhookId":"ca536c70-f01b-464d-ad81-1ca7e40696f2"},{"name":"Antwort an Fonio","parameters":{"options":{},"respondWith":"json","responseBody":"={{ $json }}"},"position":[2512,1520],"type":"n8n-nodes-base.respondToWebhook","typeVersion":1},{"credentials":{"anthropicApi":{"name":"Anthropic account 2"}},"name":"Message a model","parameters":{"messages":{"values":[{"content":"==Erstelle eine Trainingspersona für den Bereich \"{{ $json.trainingsbereich }}\".\n\nSituationsbeschreibung:\n{{ $json.beschreibung }}\n\nEntwickle eine vollständige Persona, die repräsentativ für Kunden in diesem Trainingsbereich ist."}]},"modelId":{"__rl":true,"cachedResultName":"claude-sonnet-4-20250514","mode":"list","value":"claude-sonnet-4-20250514"},"options":{"system":"Du bist ein Experte für Kundenservice-Training und spezialisiert auf die Entwicklung realistischer Trainingspersonas. Deine Aufgabe ist es, detaillierte, glaubwürdige Kundencharaktere zu erstellen, die Mitarbeiter in spezifischen Situationen trainieren können.\n\nErstelle immer Personas mit: Name, Alter, Beruf, Persönlichkeitstyp, Kommunikationsstil, emotionalem Zustand, spezifischen Bedürfnissen und typischen Problemen. Die Personas sollen für Rollenspiele geeignet und psychologisch stimmig sein."}},"position":[1936,1328],"type":"@n8n/n8n-nodes-langchain.anthropic","typeVersion":1},{"name":"Situation 'random'","parameters":{"jsCode":"// Function-Node für 'random'\n\n// Hole die trainingsDaten von \"Auswahl verarbeiten\"\nconst trainingsDaten = $('Auswahl verarbeiten').first().json.trainingsDaten;\n\nif (!trainingsDaten || trainingsDaten.length === 0) {\n    return [{ json: { action: 'error', message: 'Keine Trainingsdaten verfügbar' }}];\n}\n\n// Wähle zufälligen Trainingsbereich\nconst randomIndex = Math.floor(Math.random() * trainingsDaten.length);\nconst selectedRow = trainingsDaten[randomIndex];\n\nreturn [{ \n    json: { \n        action: 'random', \n        trainingsbereich: selectedRow.Trainingsbereich, \n        beschreibung: selectedRow.Beschreibung \n    } \n}];"},"position":[1488,1664],"type":"n8n-nodes-base.code","typeVersion":2},{"name":"Situation 'check'","parameters":{"jsCode":"// Function-Node für case 'check'\n\nconst inputItem = $input.first().json; \nconst checkBereich = inputItem.bereich;\n\n// Hole die Trainingsdaten\nlet dataRows = inputItem.trainingsDaten || []; \n\n// Der eigentliche Vergleich\nconst exists = dataRows.some(row => \n    typeof row.Trainingsbereich === 'string' && \n    row.Trainingsbereich.toLowerCase() === checkBereich.toLowerCase()\n);\n\nreturn [{ \n    json: { \n        action: 'check', \n        exists: exists,  // <- geändert von checkPassed zu exists\n        bereich: checkBereich, \n        message: exists ? 'Trainingsbereich gefunden.' : 'Trainingsbereich nicht verfügbar.' \n    } \n}];"},"position":[1264,1424],"type":"n8n-nodes-base.code","typeVersion":2},{"name":"Situation 'list'","parameters":{"jsCode":"// Function-Node für case 'list'\n\n// Hole die trainingsDaten von \"Auswahl verarbeiten\"\nconst trainingsDaten = $input.first().json.trainingsDaten;\n\nif (!trainingsDaten || trainingsDaten.length === 0) {\n    return [{ json: { action: 'error', message: 'Keine Trainingsdaten verfügbar' }}];\n}\n\n// Extrahiere alle Trainingsbereiche\nconst bereiche = trainingsDaten.map(row => row.Trainingsbereich);\n\nreturn [{ \n    json: { \n        action: 'list', \n        trainingsbereiche: bereiche, \n        totalCount: bereiche.length \n    } \n}];"},"position":[2000,1808],"type":"n8n-nodes-base.code","typeVersion":2},{"name":"Auswahl verarbeiten","parameters":{"jsCode":"// Function: Webhook-Body korrekt extrahieren + Google Sheets Daten mitgeben\n\n// 1. Hole den Body des Webhook-Requests, wo 'action' und 'bereich' liegen.\nconst webhookBody = $('Fonio Webhook Trigger').first().json.body;\n\n// 2. Hole die Google Sheets Trainingsdaten\nconst trainingsDaten = $input.all()\n  .filter(item => item.json.Trainingsbereich)\n  .map(item => item.json);\n\n// 3. Sicherheits-Check, ob die Action definiert ist\nif (!webhookBody || !webhookBody.action) {\n    return [{ json: { action: 'random', message: 'Action fehlt im Webhook Body.' } }];\n}\n\n// 4. Output erstellen mit allen Daten\nreturn [{\n    json: {\n        action: webhookBody.action, \n        bereich: webhookBody.bereich || '', \n        rufnummer: webhookBody.rufnummer || '',\n        trainingsDaten: trainingsDaten\n    }\n}];"},"position":[816,1664],"type":"n8n-nodes-base.code","typeVersion":2},{"name":"Existiert Trainingsbereich?","parameters":{"conditions":{"combinator":"and","conditions":[{"leftValue":"={{ $json.exists }}","operator":{"name":"filter.operator.equals","operation":"equals","type":"string"},"rightValue":"true"}],"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2}},"options":{}},"position":[1488,1424],"type":"n8n-nodes-base.if","typeVersion":2.2},{"name":"Antwort formatieren","parameters":{"jsCode":"// Hole die action von der richtigen Stelle\nlet action;\nlet trainingsbereich;\n\n// Versuche von \"Beschreibung des Trainingsbereichs holen\"\nconst beschreibungNode = $('Beschreibung des Trainingsbereichs holen').first();\nif (beschreibungNode && beschreibungNode.json) {\n  action = beschreibungNode.json.action;\n  trainingsbereich = beschreibungNode.json.trainingsbereich;\n} else {\n  // Fallback auf aktuellen Input\n  action = $input.first().json.action;\n  trainingsbereich = $input.first().json.trainingsbereich;\n}\n\n// Timestamp\nconst timestamp = new Date().toISOString();\n\nswitch (action) {\n  \n  case 'list':\n    const listInput = $('Situation \\'list\\'').first().json;\n    const bereichsListe = listInput.trainingsbereiche.join(', ');\n    return [{\n      json: {\n        success: true,\n        action: 'list',\n        message: `Verfügbare Trainingsbereiche: ${bereichsListe}`,\n        trainingsbereiche: listInput.trainingsbereiche,\n        totalCount: listInput.totalCount,\n        timestamp: timestamp\n      }\n    }];\n    \n  case 'check':\n    // Prüfe ob Persona generiert wurde\n    if (trainingsbereich) {\n      // Persona wurde generiert\n      const claudeOutput = $('Message a model').first().json;\n      return [{\n        json: {\n          success: true,\n          action: 'check',\n          trainingsbereich: trainingsbereich,\n          persona: claudeOutput.content[0].text,\n          timestamp: timestamp\n        }\n      }];\n    } else {\n      // Bereich existiert nicht\n      const checkInput = $('Situation \\'check\\'').first().json;\n      return [{\n        json: {\n          success: false,\n          action: 'check',\n          bereich: checkInput.bereich,\n          exists: checkInput.exists,\n          message: checkInput.message,\n          timestamp: timestamp\n        }\n      }];\n    }\n    \n  case 'random':\n    // Persona wurde generiert\n    const claudeOutput = $('Message a model').first().json;\n    const randomNode = $('Beschreibung des Trainingsbereichs holen').first().json;\n    return [{\n      json: {\n        success: true,\n        action: 'random',\n        trainingsbereich: randomNode.trainingsbereich,\n        persona: claudeOutput.content[0].text,\n        timestamp: timestamp\n      }\n    }];\n    \n  default:\n    return [{\n      json: {\n        success: false,\n        error: \"Unbekannte Aktion\",\n        receivedAction: action,\n        timestamp: timestamp\n      }\n    }];\n}"},"position":[2288,1328],"type":"n8n-nodes-base.code","typeVersion":2},{"credentials":{"googleApi":{"name":"n8n Google Sheets account"}},"name":"Google Sheets lesen","parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"mode":"id","value":"1KCGCBwtzQ82m8xQB47K7vGR6BXaZY21TNSiqAOh_ROk"},"options":{},"sheetName":{"__rl":true,"cachedResultName":"E-Commerce","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1KCGCBwtzQ82m8xQB47K7vGR6BXaZY21TNSiqAOh_ROk/edit#gid=0","mode":"list","value":"gid=0"}},"position":[592,1664],"type":"n8n-nodes-base.googleSheets","typeVersion":4},{"name":"Modus prüfen","parameters":{"options":{},"rules":{"values":[{"conditions":{"combinator":"and","conditions":[{"leftValue":"={{ $('Auswahl verarbeiten').item.json.action }}","operator":{"operation":"equals","type":"string"},"rightValue":"=check"}],"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2}},"outputKey":"Modus Check","renameOutput":true},{"conditions":{"combinator":"and","conditions":[{"leftValue":"={{ $('Auswahl verarbeiten').item.json.action }}","operator":{"name":"filter.operator.equals","operation":"equals","type":"string"},"rightValue":"random"}],"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2}},"outputKey":"Modus Random","renameOutput":true},{"conditions":{"combinator":"and","conditions":[{"leftValue":"={{ $('Auswahl verarbeiten').item.json.action }}","operator":{"name":"filter.operator.equals","operation":"equals","type":"string"},"rightValue":"list"}],"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2}},"outputKey":"Modus List","renameOutput":true}]}},"position":[1040,1648],"type":"n8n-nodes-base.switch","typeVersion":3.3},{"name":"Beschreibung des Trainingsbereichs holen","parameters":{"jsCode":"// Hole die Input-Action (kann 'check' oder 'random' sein)\nconst inputData = $input.first().json;\nconst action = inputData.action;\nconst bereich = inputData.bereich || null;\n\n// Hole die trainingsDaten\nconst trainingsDaten = $('Auswahl verarbeiten').first().json.trainingsDaten;\n\nlet trainingsRow;\n\nif (bereich) {\n  // Bei 'check': Spezifischen Bereich finden\n  trainingsRow = trainingsDaten.find(row => \n      row.Trainingsbereich && \n      row.Trainingsbereich.toLowerCase() === bereich.toLowerCase()\n  );\n} else {\n  // Bei 'random': Zufälligen Bereich wählen\n  const randomIndex = Math.floor(Math.random() * trainingsDaten.length);\n  trainingsRow = trainingsDaten[randomIndex];\n}\n\n// Beschreibung parsen und eine Situation zufällig auswählen\nconst beschreibung = trainingsRow.Beschreibung || 'Keine Beschreibung verfügbar';\n\n// Extrahiere alle Situationen (Zeilen die mit \"- \" beginnen)\nconst situationen = beschreibung\n  .split('\\n')\n  .filter(line => line.trim().startsWith('- '))\n  .map(line => line.trim().substring(2)); // Entferne \"- \" Prefix\n\nlet selectedSituation;\n\nif (situationen.length > 0) {\n  // Wähle eine zufällige Situation\n  const randomIndex = Math.floor(Math.random() * situationen.length);\n  selectedSituation = situationen[randomIndex];\n} else {\n  // Falls keine Situationen mit \"- \" gefunden, nutze die komplette Beschreibung\n  selectedSituation = beschreibung;\n}\n\n// Output - mit nur EINER Situation\nreturn [{\n    json: {\n        action: action,\n        trainingsbereich: trainingsRow.Trainingsbereich,\n        beschreibung: selectedSituation  // <- Nur eine zufällige Situation!\n    }\n}];"},"position":[1712,1328],"type":"n8n-nodes-base.code","typeVersion":2},{"name":"Trainingsbereich existiert nicht","parameters":{"jsCode":"const checkInput = $input.first().json;\n\nreturn [{\n  json: {\n    success: false,\n    action: 'check',\n    trainingsbereich: checkInput.trainingsbereich,  // <- geändert\n    answer: `Der Trainingsbereich \"${checkInput.trainingsbereich}\" existiert leider nicht. Möchtest du die verfügbare Liste hören?`,\n    timestamp: new Date().toISOString()\n  }\n}];"},"position":[2288,1520],"type":"n8n-nodes-base.code","typeVersion":2},{"name":"Liste der Trainingsbereiche","parameters":{"jsCode":"// Formatiere die Liste für Fonio\nconst listInput = $input.first().json;\nconst bereichsListe = listInput.trainingsbereiche.join(', ');\n\nreturn [{\n  json: {\n    success: true,\n    action: 'list',\n    message: `Verfügbare Trainingsbereiche: ${bereichsListe}`,\n    trainingsbereiche: listInput.trainingsbereiche,\n    totalCount: listInput.totalCount,\n    timestamp: new Date().toISOString()\n  }\n}];"},"position":[2288,1808],"type":"n8n-nodes-base.code","typeVersion":2}],"settings":{"availableInMCP":true,"callerPolicy":"workflowsFromSameOwner","executionOrder":"v1"}}